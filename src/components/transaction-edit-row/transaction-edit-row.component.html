<li class="p-3 sm:p-4 bg-gray-50">
  <form [formGroup]="transactionForm" (ngSubmit)="onSubmit()">
    <div class="flex flex-col w-full">
      
      <!-- ROW 1: Header / Controls -->
      <div class="flex justify-between items-center mb-4">
        <!-- Buy/Sell Switch -->
        <div class="inline-flex rounded-md shadow-sm" role="group">
          <button 
            type="button" 
            (click)="setTransactionType('buy')"
            [class]="transactionForm.get('transactionType')?.value === 'buy' ? 'bg-gray-900 text-white ring-1 ring-gray-900' : 'bg-white text-gray-700 hover:bg-gray-50 ring-1 ring-inset ring-gray-300'"
            class="px-4 py-2 text-sm font-medium rounded-l-lg focus:z-10 focus:ring-2 focus:ring-gray-800 transition-colors duration-150">
            Buy
          </button>
          <button 
            type="button" 
            (click)="setTransactionType('sell')"
            [class]="transactionForm.get('transactionType')?.value === 'sell' ? 'bg-gray-900 text-white ring-1 ring-gray-900' : 'bg-white text-gray-700 hover:bg-gray-50 ring-1 ring-inset ring-gray-300'"
            class="-ml-px px-4 py-2 text-sm font-medium rounded-r-md focus:z-10 focus:ring-2 focus:ring-gray-800 transition-colors duration-150">
            Sell
          </button>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-3">
          <button type="submit" [disabled]="transactionForm.invalid" class="p-2 text-green-600 hover:bg-green-100 rounded-full transition-colors duration-150 disabled:text-gray-400 disabled:hover:bg-transparent">
            <span class="sr-only">Save</span>
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
            </svg>
          </button>
          <button type="button" (click)="onCancel()" class="p-2 text-red-600 hover:bg-red-100 rounded-full transition-colors duration-150">
            <span class="sr-only">Cancel</span>
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
      
      <!-- ROW 2: Data Entry (Full Width) -->
      <div class="flex flex-col lg:flex-row w-full gap-5 items-end">
        <!-- 1. Ticker Column -->
        <div class="flex flex-col gap-1 flex-[3] relative">
          <label for="ticker" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Ticker</label>
          <input 
            #tickerInput
            id="ticker" 
            type="text" 
            name="transactionTicker"
            formControlName="ticker" 
            autocomplete="off"
            spellcheck="false"
            aria-label="Ticker" 
            aria-autocomplete="list"
            aria-expanded="{{ showDropdown() }}"
            (focus)="onTickerInputFocus()"
            (blur)="onTickerInputBlur()"
            (keydown)="onKeyDown($event)"
            class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent uppercase placeholder-gray-300" 
            required>
          
          <!-- Autocomplete Dropdown -->
          @if (showDropdown() && filteredSecurities().length > 0) {
            <ul 
              class="absolute top-full left-0 mt-1 w-80 bg-white border border-gray-200 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto"
              role="listbox">
              @for (security of filteredSecurities(); track security.id; let i = $index) {
                <li 
                  (click)="selectSecurity(security)"
                  (mousedown)="$event.preventDefault()"
                  [class]="'cursor-pointer px-4 py-2 hover:bg-gray-50 border-b border-gray-100 last:border-0 ' + (selectedIndex() === i ? 'bg-gray-50' : '')"
                  [attr.aria-selected]="selectedIndex() === i"
                  role="option">
                  <div class="text-sm font-medium text-gray-900 leading-tight mb-0.5 break-words">
                    {{ security.securityName }}
                  </div>
                  <div class="text-xs text-gray-500">
                    {{ security.ticker }}
                  </div>
                </li>
              }
            </ul>
          }
        </div>
        
        <!-- 2. Date Column -->
        <div class="flex flex-col gap-1 w-32">
          <label for="date" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Date</label>
          <input 
            id="date" 
            type="date" 
            formControlName="date" 
            aria-label="Transaction Date" 
            class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent" 
            required>
        </div>
        
        <!-- 3. Shares Column -->
        <div class="flex flex-col gap-1 flex-1 min-w-[80px]">
          <label for="shares" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Shares</label>
          <input 
            id="shares" 
            type="number" 
            formControlName="shares" 
            aria-label="Shares" 
            (wheel)="$event.preventDefault()"
            class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent placeholder-gray-300" 
            required>
        </div>
        
        <!-- 4. Price Column -->
        <div class="flex flex-col gap-1 flex-1 min-w-[80px]">
          <label for="sharePrice" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Price</label>
          <input 
            id="sharePrice" 
            type="number" 
            formControlName="sharePrice" 
            aria-label="Price per Share" 
            step="0.01"
            (wheel)="$event.preventDefault()"
            placeholder="0.00"
            class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent placeholder-gray-300" 
            required>
        </div>
        
        <!-- 5. Fees Column -->
        <div class="flex flex-col gap-1 flex-1 min-w-[60px]">
          <label for="fees" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Fees</label>
          <input 
            id="fees" 
            type="number" 
            formControlName="fees" 
            placeholder="0.00" 
            aria-label="Fees" 
            step="0.01"
            (wheel)="$event.preventDefault()"
            class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent placeholder-gray-300">
        </div>
        
        <!-- 6. Total (Read-only) -->
        <div class="flex flex-col gap-1 pb-1 w-auto whitespace-nowrap">
          <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Total</span>
          <span [class]="'font-bold text-lg ' + getTotalColorClass()">
            {{ estimatedTotal() | currency:'EUR':'symbol':'1.2-2' }}
          </span>
        </div>
      </div>
    </div>
  </form>
</li>
