<li class="p-3 sm:p-4 bg-gray-50 relative">
  <!-- Custom Tooltip -->
  @if (activeTooltip(); as tooltip) {
    <div
      class="fixed z-50 pointer-events-none bg-gray-900 text-white text-xs font-medium py-1.5 px-3 rounded shadow-lg transform -translate-x-1/2 -translate-y-full mt-[-8px]"
      [style.left.px]="tooltip.x"
      [style.top.px]="tooltip.y"
    >
      {{ tooltip.text }}
    </div>
  }
  
  <form [formGroup]="transactionForm" (ngSubmit)="onSubmit()">
    <div class="flex flex-col w-full">
      
      <!-- ROW 1: Header / Controls -->
      <div class="flex justify-between items-center mb-4">
        <!-- Buy/Sell/Dividend/Split Switch -->
        <div class="inline-flex rounded-md shadow-sm" role="group">
          <button 
            type="button" 
            (click)="setTransactionType('buy')"
            [class]="transactionForm.get('transactionType')?.value === 'buy' ? 'bg-gray-900 text-white ring-1 ring-gray-900' : 'bg-white text-gray-700 hover:bg-gray-50 ring-1 ring-inset ring-gray-300'"
            class="px-4 py-2 text-sm font-medium rounded-l-lg focus:z-10 focus:ring-2 focus:ring-gray-800 transition-colors duration-150">
            Buy
          </button>
          <button 
            type="button" 
            (click)="setTransactionType('sell')"
            [class]="transactionForm.get('transactionType')?.value === 'sell' ? 'bg-gray-900 text-white ring-1 ring-gray-900' : 'bg-white text-gray-700 hover:bg-gray-50 ring-1 ring-inset ring-gray-300'"
            class="-ml-px px-4 py-2 text-sm font-medium focus:z-10 focus:ring-2 focus:ring-gray-800 transition-colors duration-150">
            Sell
          </button>
          <button 
            type="button" 
            (click)="setTransactionType('dividend')"
            [class]="transactionForm.get('transactionType')?.value === 'dividend' ? 'bg-gray-900 text-white ring-1 ring-gray-900' : 'bg-white text-gray-700 hover:bg-gray-50 ring-1 ring-inset ring-gray-300'"
            class="-ml-px px-4 py-2 text-sm font-medium focus:z-10 focus:ring-2 focus:ring-gray-800 transition-colors duration-150">
            Dividend
          </button>
          <button 
            type="button" 
            (click)="setTransactionType('split')"
            [class]="transactionForm.get('transactionType')?.value === 'split' ? 'bg-gray-900 text-white ring-1 ring-gray-900' : 'bg-white text-gray-700 hover:bg-gray-50 ring-1 ring-inset ring-gray-300'"
            class="-ml-px px-4 py-2 text-sm font-medium rounded-r-md focus:z-10 focus:ring-2 focus:ring-gray-800 transition-colors duration-150">
            Split
          </button>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-3">
          <button type="submit" [disabled]="transactionForm.invalid" class="p-2 text-green-600 hover:bg-green-100 rounded-full transition-colors duration-150 disabled:text-gray-400 disabled:hover:bg-transparent">
            <span class="sr-only">Save</span>
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
            </svg>
          </button>
          <!-- Cancel button only shown when editing (not when adding new) -->
          @if (initialState()) {
            <button type="button" (click)="onCancel()" class="p-2 text-red-600 hover:bg-red-100 rounded-full transition-colors duration-150">
              <span class="sr-only">Cancel</span>
              <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
              </svg>
            </button>
          }
        </div>
      </div>
      
      <!-- ROW 2: Data Entry (Full Width) -->
      <div class="flex flex-col lg:flex-row w-full gap-5 items-end">
        <!-- 1. Ticker Column -->
        <div class="flex flex-col gap-1 flex-1 relative">
          <label for="ticker" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Ticker</label>
          <input 
            #tickerInput
            id="ticker" 
            type="text" 
            name="transactionTicker"
            formControlName="ticker" 
            autocomplete="off"
            spellcheck="false"
            aria-label="Ticker" 
            aria-autocomplete="list"
            aria-expanded="{{ showDropdown() }}"
            (focus)="onTickerInputFocus()"
            (blur)="onTickerInputBlur()"
            (keydown)="onKeyDown($event)"
            class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent uppercase placeholder-gray-300" 
            required>
          
          <!-- Autocomplete Dropdown -->
          @if (showDropdown() && filteredSecurities().length > 0) {
            <ul 
              class="absolute top-full left-0 mt-1 w-80 bg-white border border-gray-200 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto"
              role="listbox">
              @for (security of filteredSecurities(); track security.id; let i = $index) {
                <li 
                  (click)="selectSecurity(security)"
                  (mousedown)="$event.preventDefault()"
                  [class]="'cursor-pointer px-4 py-2 hover:bg-gray-50 border-b border-gray-100 last:border-0 ' + (selectedIndex() === i ? 'bg-gray-50' : '')"
                  [attr.aria-selected]="selectedIndex() === i"
                  role="option">
                  <div class="text-sm font-medium text-gray-900 leading-tight mb-0.5 break-words">
                    {{ security.name }}
                  </div>
                  <div class="text-xs text-gray-500">
                    {{ security.ticker }}
                  </div>
                </li>
              }
            </ul>
          }
        </div>
        
        <!-- 2. Date Column -->
        <div class="flex flex-col gap-1 flex-1">
          <label for="date" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Date</label>
          <input 
            id="date" 
            type="date" 
            formControlName="date" 
            aria-label="Transaction Date" 
            class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent" 
            required>
        </div>
        
        <!-- 3. Shares Column (or Split Ratio for splits) -->
        @if (isSplit()) {
          <!-- Split Ratio Input (X-for-Y format) -->
          <div class="flex flex-col gap-1 flex-1">
            <div class="flex items-center gap-1">
              <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Split Ratio</label>
              <button
                type="button"
                class="flex items-center justify-center w-3.5 h-3.5 rounded-full bg-gray-300 hover:bg-gray-400 text-white text-[10px] font-bold transition-colors cursor-help"
                (mouseenter)="showTooltip($event, getSplitRatioDisplay())"
                (mouseleave)="hideTooltip()"
                (mousemove)="showTooltip($event, getSplitRatioDisplay())"
                aria-label="Split ratio information"
              >
                ?
              </button>
            </div>
            <div class="flex items-center gap-1.5">
              <input 
                type="number" 
                [value]="splitYouReceive()"
                (input)="onSplitYouReceiveChange($event)"
                min="0.01"
                step="0.01"
                (wheel)="$event.preventDefault()"
                class="w-14 border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent text-center" 
                required>
              <span class="text-xs text-gray-500">-for-</span>
              <input 
                type="number" 
                [value]="splitForEvery()"
                (input)="onSplitForEveryChange($event)"
                min="1"
                step="1"
                (wheel)="$event.preventDefault()"
                class="w-14 border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent text-center" 
                required>
            </div>
          </div>
        } @else {
          <div class="flex flex-col gap-1 flex-1">
            <label for="shares" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Shares</label>
            <input 
              id="shares" 
              type="number" 
              formControlName="shares" 
              aria-label="Shares" 
              (wheel)="$event.preventDefault()"
              class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent placeholder-gray-300" 
              required>
          </div>
        }
        
        <!-- 4. Price Column (Hidden for Dividend and Split) -->
        @if (!isDividend() && !isSplit()) {
          <div class="flex flex-col gap-1 flex-1">
            <label for="sharePrice" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Price</label>
            <input 
              id="sharePrice" 
              type="number" 
              formControlName="sharePrice" 
              aria-label="Price per Share" 
              step="0.01"
              (wheel)="$event.preventDefault()"
              placeholder="0.00"
              class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent placeholder-gray-300" 
              required>
          </div>
        }
        
        <!-- 4c. Share Price Info (Only for Split) -->
        @if (isSplit()) {
          <div class="flex flex-col gap-1 flex-1">
            <div class="flex items-center gap-1">
              <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Share Price</label>
              <button
                type="button"
                class="flex items-center justify-center w-3.5 h-3.5 rounded-full bg-gray-300 hover:bg-gray-400 text-white text-[10px] font-bold transition-colors cursor-help"
                (mouseenter)="showTooltip($event, 'Stock splits don\'t involve money exchange')"
                (mouseleave)="hideTooltip()"
                (mousemove)="showTooltip($event, 'Stock splits don\'t involve money exchange')"
                aria-label="Share price information"
              >
                ?
              </button>
            </div>
            <div class="py-1 text-sm font-medium text-gray-400">
              €0.00
            </div>
          </div>
        }
        
        <!-- 5. Fees Column (Hidden for Dividend and Split) -->
        @if (!isDividend() && !isSplit()) {
          <div class="flex flex-col gap-1 flex-1">
            <label for="fees" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Fees</label>
            <input 
              id="fees" 
              type="number" 
              formControlName="fees" 
              placeholder="0.00" 
              aria-label="Fees" 
              step="0.01"
              (wheel)="$event.preventDefault()"
              class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent placeholder-gray-300">
          </div>
        }
        
        <!-- 4b. Net Received Column (Only for Dividend) -->
        @if (isDividend()) {
          <div class="flex flex-col gap-1 flex-1">
            <label for="totalAmount" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Net Received (€)</label>
            <input 
              id="totalAmount" 
              type="number" 
              formControlName="totalAmount" 
              aria-label="Net Received" 
              step="0.01"
              (wheel)="$event.preventDefault()"
              placeholder="0.00"
              class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent placeholder-gray-300" 
              required>
          </div>
        }
        
        <!-- 5b. Tax Column (Only for Dividend) -->
        @if (isDividend()) {
          <div class="flex flex-col gap-1 flex-1">
            <label for="tax" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Tax Withheld (€)</label>
            <input 
              id="tax" 
              type="number" 
              formControlName="tax" 
              placeholder="0.00" 
              aria-label="Tax Withheld" 
              step="0.01"
              (wheel)="$event.preventDefault()"
              class="w-full border-b border-gray-200 py-1 text-sm font-medium focus:border-black outline-none bg-transparent placeholder-gray-300">
          </div>
        }
        
        <!-- 6. Total / Gross Amount (Read-only) - Hidden for Split -->
        @if (!isSplit()) {
          <div class="flex flex-col gap-1 pb-1 w-auto whitespace-nowrap">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{{ getTotalLabel() }}</span>
            <span [class]="'font-bold text-lg ' + getTotalColorClass()">
              {{ estimatedTotal() | currency:'EUR':'symbol':'1.2-2' }}
            </span>
          </div>
        }
      </div>
    </div>
  </form>
</li>
