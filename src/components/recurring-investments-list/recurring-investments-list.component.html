<div class="h-full overflow-hidden flex flex-col min-w-0 w-full">
  <!-- Navigation Pane -->
  <div class="flex items-baseline gap-x-3 sm:gap-x-4 mb-3 flex-shrink-0">
    <button 
      (click)="navigateToTransactions.emit()" 
      class="text-sm font-medium text-gray-400 hover:text-gray-600 transition-colors">
      Historical Transactions
    </button>
    <h2 class="text-sm font-bold tracking-tight text-gray-900">Recurring Investments</h2>
  </div>
  
  <!-- Add New Bar -->
  <div class="mb-2 flex-shrink-0">
    <form [formGroup]="addNewForm" (ngSubmit)="addSchedule()" class="flex flex-col lg:flex-row gap-4 items-end">
      <!-- Ticker Autocomplete -->
      <div class="flex flex-col gap-1 flex-1 relative">
        <input 
          #tickerInput
          id="addTicker" 
          type="text" 
          name="recurringTicker"
          formControlName="ticker" 
          autocomplete="off"
          spellcheck="false"
          (input)="onTickerInput($event)"
          (focus)="onTickerInputFocus()"
          (blur)="onTickerInputBlur()"
          (keydown)="onKeyDown($event)"
          class="w-full py-2 text-lg font-light text-gray-900 placeholder-gray-400 border-transparent bg-transparent hover:bg-gray-50 focus:bg-gray-50 rounded transition-all duration-200 outline-none uppercase" 
          placeholder="Type to add asset..."
          required>
        
        <!-- Autocomplete Dropdown -->
        @if (showDropdown() && filteredSecurities().length > 0) {
          <ul 
            class="absolute top-full left-0 mt-1 w-80 bg-white border border-gray-200 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto"
            role="listbox">
            @for (security of filteredSecurities(); track security.id; let i = $index) {
              <li 
                (click)="selectSecurity(security)"
                (mousedown)="$event.preventDefault()"
                [class]="'cursor-pointer px-4 py-2 hover:bg-gray-50 border-b border-gray-100 last:border-0 ' + (selectedIndex() === i ? 'bg-gray-50' : '')"
                [attr.aria-selected]="selectedIndex() === i"
                role="option">
                <div class="text-sm font-medium text-gray-900 leading-tight mb-0.5 break-words">
                  {{ security.securityName }}
                </div>
                <div class="text-xs text-gray-500">
                  {{ security.ticker }}
                </div>
              </li>
            }
          </ul>
        }
      </div>

      <!-- Add Button -->
      <button 
        type="submit"
        [disabled]="addNewForm.invalid"
        class="px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-md hover:bg-gray-800 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
        Add
      </button>
    </form>
  </div>

  <!-- Grid Content -->
  <div class="flex-1 overflow-y-auto min-w-0 w-full" style="scrollbar-gutter: stable;">
    @if (loading()) {
      <div class="flex items-center justify-center py-12">
        <div class="text-sm text-gray-500">Loading...</div>
      </div>
    } @else if (filteredSchedules().length === 0) {
      <div class="flex flex-col items-center justify-center h-full text-gray-400 py-12">
        <svg class="w-16 h-16 sm:w-24 sm:h-24 mb-4 opacity-50" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-base sm:text-lg font-medium">No recurring investments</p>
        <p class="text-xs sm:text-sm mt-2">Add assets above to get started</p>
      </div>
    } @else {
      <!-- Grid Header -->
      <div class="hidden lg:flex items-center gap-0 pb-2 border-b border-gray-100 text-[10px] font-bold text-gray-400 uppercase tracking-widest w-full">
        <div class="w-[30%] shrink-0 truncate pr-4">Asset</div>
        <div class="w-[20%] shrink-0">Date</div>
        <div class="w-[10%] shrink-0 text-right">Shares</div>
        <div class="w-[15%] shrink-0 text-right">Price</div>
        <div class="w-[10%] shrink-0 text-right">Fees</div>
        <div class="w-[15%] shrink-0 text-right">Total</div>
      </div>

      <!-- Grid Rows -->
      <form [formGroup]="gridForm" class="w-full min-w-0">
        <div formArrayName="rows" class="w-full min-w-0">
          @for (rowGroup of rowsFormArray.controls; track rowGroup.get('scheduleId')?.value; let i = $index) {
            @if (getScheduleForRow(i)) {
              @let schedule = getScheduleForRow(i)!;
              <div [formGroupName]="i" class="relative group flex flex-col lg:flex-row lg:items-center gap-0 border-b border-gray-100 py-2 hover:bg-gray-50/50 transition-colors w-full">
                <!-- Asset Info (Left) -->
                <div class="w-[30%] shrink-0 truncate pr-4">
                  <div class="font-bold text-gray-900 truncate text-sm">
                    {{ schedule.securityName }}
                  </div>
                  <div class="flex items-center gap-2 text-xs text-gray-500 truncate">
                    <span>{{ schedule.ticker }}</span>
                    @if (schedule.targetAmount) {
                      <span>• Goal: {{ schedule.targetAmount | currency:'EUR':'symbol':'1.0-0' }}</span>
                    }
                  </div>
                </div>

                <!-- Date -->
                <div class="flex flex-col gap-1 w-[20%] shrink-0">
                  <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest lg:hidden">Date</label>
                  <input 
                    type="date"
                    formControlName="date"
                    class="w-full py-1 text-sm font-medium text-gray-900 border-transparent bg-transparent hover:bg-gray-50 focus:bg-gray-50 rounded transition-all duration-200 outline-none">
                </div>

                <!-- Shares -->
                <div class="flex flex-col gap-1 w-[10%] shrink-0">
                  <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest lg:hidden">Shares</label>
                  <input 
                    type="number"
                    step="0.0001"
                    formControlName="shares"
                    placeholder="0.00"
                    class="w-full py-1 text-sm font-mono text-right text-gray-900 border-transparent bg-transparent hover:bg-gray-50 focus:bg-gray-50 rounded transition-all duration-200 outline-none placeholder-gray-400">
                </div>

                <!-- Price -->
                <div class="flex flex-col gap-1 w-[15%] shrink-0">
                  <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest lg:hidden">Price</label>
                  <input 
                    type="number"
                    step="0.01"
                    formControlName="sharePrice"
                    placeholder="Price"
                    class="w-full py-1 text-sm font-mono text-right text-gray-900 border-transparent bg-transparent hover:bg-gray-50 focus:bg-gray-50 rounded transition-all duration-200 outline-none placeholder-gray-400">
                </div>

                <!-- Fees -->
                <div class="flex flex-col gap-1 w-[10%] shrink-0">
                  <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest lg:hidden">Fees</label>
                  <input 
                    type="number"
                    step="0.01"
                    formControlName="fees"
                    placeholder="0.00"
                    class="w-full py-1 text-sm font-mono text-right text-gray-900 border-transparent bg-transparent hover:bg-gray-50 focus:bg-gray-50 rounded transition-all duration-200 outline-none placeholder-gray-400">
                </div>

                <!-- Total (Read-only) -->
                <div class="flex flex-col gap-1 w-[15%] shrink-0">
                  <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest lg:hidden">Total</label>
                  <div class="font-mono text-sm font-bold text-gray-900 text-right py-1">
                    @if (getRowTotal(i) > 0) {
                      {{ getRowTotal(i) | currency:'EUR':'symbol':'1.2-2' }}
                    } @else {
                      <span class="text-gray-300">—</span>
                    }
                  </div>
                </div>

                <!-- Floating Delete Button (Pill) -->
                <button 
                  type="button"
                  (click)="deleteSchedule(schedule.id)"
                  class="absolute right-2 top-1/2 -translate-y-1/2 bg-white shadow-md border border-gray-100 rounded-full p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 opacity-0 group-hover:opacity-100 transition-all z-10 lg:block hidden">
                  <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                  </svg>
                </button>

                <!-- Delete Button (Mobile) -->
                <button 
                  type="button"
                  (click)="deleteSchedule(schedule.id)"
                  class="lg:hidden p-1 text-gray-400 hover:text-red-600 transition-colors">
                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                  </svg>
                </button>
              </div>
            }
          }
        </div>
      </form>
    }
  </div>

  <!-- Execute Footer (Sticky) -->
  @if (filteredSchedules().length > 0) {
    <div class="flex-shrink-0 pt-4 border-t border-gray-200 mt-auto">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-600">
          @if (validTransactionCount() > 0) {
            <span class="font-medium">{{ validTransactionCount() }}</span> transaction{{ validTransactionCount() > 1 ? 's' : '' }} ready to log
          } @else {
            Fill in shares and price to log transactions
          }
        </div>
        <button 
          type="button"
          (click)="executeTransactions(); $event.stopPropagation()"
          [disabled]="validTransactionCount() === 0"
          class="px-6 py-2 text-sm font-medium text-white bg-gray-900 rounded-md hover:bg-gray-800 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
          Log {{ validTransactionCount() }} Transaction{{ validTransactionCount() !== 1 ? 's' : '' }}
        </button>
      </div>
    </div>
  }
</div>
