
<div class="planning-container" [formGroup]="planningForm">
  <!-- Top Bar: Add Security & Global Settings -->
  <div class="top-bar">
    <div class="search-section">
      <app-add-security-search (securitySelected)="addSecurity($event)"></app-add-security-search>
    </div>
    
    <div class="investment-setting">
      <label>Monthly Budget</label>
      <div class="amount-input">
        <span class="currency">€</span>
        <input type="number" formControlName="monthlyInvestment" />
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-area">
    <div class="start-instruction" *ngIf="!groupedRows.length">
      <p>Start by adding securities to your plan above.</p>
    </div>

    <div class="asset-list" *ngIf="groupedRows.length">
      
      <!-- Groups -->
      <div class="asset-group" *ngFor="let group of groupedRows">
        <div class="group-header" (click)="toggleGroup(group)">
          <div class="group-title">
            <span class="expand-icon" [class.expanded]="group.isExpanded">▸</span>
            <span>{{ group.assetType }}</span>
          </div>
          <div class="group-subtotal">
            {{ getSubtotal(group) | number:'1.0-2' }}%
          </div>
        </div>

        <div class="group-items" *ngIf="group.isExpanded">
          <ng-container *ngFor="let row of group.rows">
            <div class="list-item" *ngIf="getRowFormGroup(row) as rowGroup" [formGroup]="rowGroup">
              
              <!-- Asset Info -->
              <div class="col-asset">
                <div class="ticker">{{ row.ticker }}</div>
                <div class="company">{{ row.securityName }}</div>
              </div>

              <!-- Target Allocation -->
              <div class="col-allocation">
                <div class="input-wrapper">
                  <input type="number" formControlName="targetPercentage" />
                  <span class="unit">%</span>
                </div>
                <!-- Save Status Indicator -->
                <span class="save-status" [ngClass]="getSaveStatus(row.ticker)">
                  <ng-container [ngSwitch]="getSaveStatus(row.ticker)">
                    <span *ngSwitchCase="'saving'" class="saving">⏳</span>
                    <span *ngSwitchCase="'saved'" class="saved">✓</span>
                    <span *ngSwitchCase="'error'" class="error">✗</span>
                  </ng-container>
                </span>
              </div>

              <!-- Estimated Amount -->
              <div class="col-estimation">
                <span class="label">Est.</span>
                <span class="value">
                  {{ (monthlyInvestmentControl.value * (rowGroup.get('targetPercentage')?.value || 0) / 100) | number:'1.0-0' }} €
                </span>
              </div>

              <!-- Frequency Toggles -->
              <div class="col-frequency">
                <button type="button" 
                        [class.active]="rowGroup.get('isWeeklyEnabled')?.value" 
                        (click)="toggleWeekly(rowGroup)"
                        title="Weekly">W</button>
                <button type="button" 
                        [class.active]="rowGroup.get('isBiWeeklyEnabled')?.value" 
                        (click)="toggleBiWeekly(rowGroup)"
                        title="Bi-Weekly">B</button>
                <button type="button" 
                        [class.active]="rowGroup.get('isMonthlyEnabled')?.value" 
                        (click)="toggleMonthly(rowGroup)"
                        title="Monthly">M</button>
              </div>

              <!-- Delete Action -->
              <div class="col-action">
                <button type="button" class="delete-btn" (click)="deleteSecurity(row.ticker, $event)" title="Remove">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </div>

            </div>
          </ng-container>
        </div>
      </div>

    </div>
  </div>

  <!-- Footer Stats -->
  <div class="footer-stats" *ngIf="groupedRows.length">
    <div class="stat-item">
      <span>Total Allocated</span>
      <span [class.over-budget]="grandTotal > 100" [class.under-budget]="grandTotal < 100" class="value">
        {{ grandTotal | number:'1.0-2' }}%
      </span>
    </div>
  </div>
</div>
